<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin panel</title>
    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
          integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
          crossorigin="anonymous">
</head>
<body style="background-color: #f2f2f2">
<header class="bg-dark text-white p-3 h4">
    <span id="adminEmail" class="font-weight-bold"></span>
    <span class="font-weight-light">with roles:</span>
    <span id="adminRoles" class="font-weight-light"></span>

    <a href="/logout" class="text-white-50 bg-dark float-right">Logout</a>
</header>

<div>

    <div class="row">

        <div class="p-0 pl-3 bg-white" style="width: 300px">
            <nav class="nav flex-column">
                <a class="d-block p-3 bg-primary text-white" href="/admin">Admin</a>
                <a class="d-block p-3" href="/user">User</a>
            </nav>
        </div>

        <div class="col">
            <h1 class="pb-3">
                Admin panel
            </h1>
            <div
                    style="height: 50px;
                    width: 1200px;
                    background-color: white;
                     display: flex;
                     align-items: center;
                     justify-content: space-between;
                     padding: 10px">

                <span class="font-weight-bold">All Users</span>
                <button
                        class="btn btn-primary"
                        id="addUserButton"
                        data-toggle="modal"
                        data-target="#userModal">

                    New User

                </button>

            </div>
            <table class="table bg-white" style="width: 1200px">
                <thead>
                <tr>
                    <th scope="col">ID</th>
                    <th scope="col">Имя</th>
                    <th scope="col">Email</th>
                    <th scope="col">Роль</th>
                    <th scope="col">Действия</th>
                </tr>
                </thead>
                <tbody id="usersBody"></tbody>
            </table>
        </div>

    </div>

</div>

<!-- Модальное окно для добавления и редактирования пользователя -->
<div class="modal fade" id="userModal" tabindex="-1" role="dialog" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userModalLabel">Добавить пользователя</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="form-group">
                        <label for="name">Имя</label>
                        <input type="text" id="name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Пароль</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="roles">Роли</label>
                        <select multiple id="roles" class="form-control"></select>
                    </div>
                    <button type="submit" class="btn btn-primary float-right">Сохранить</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>

<script>
    const apiUrl = '/admin/api';

    async function fetchAdminData() {
        const response = await fetch(`${apiUrl}/admin`);
        const adminData = await response.json();
        document.getElementById('adminEmail').textContent = adminData.email;
        document.getElementById('adminRoles').textContent = adminData.roles.map(role => role.name.substring(5)).join(', ');

    }

    async function fetchUsers() {
        const response = await fetch(`${apiUrl}/users`);
        const users = await response.json();
        const userTableBody = document.getElementById('usersBody');
        userTableBody.innerHTML = '';
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.roles.map(role => role.name.substring(5)).join(', ')}</td>
                <td>
                    <button class="btn btn-info" onclick="editUser(${user.id})">Edit</button>
                    <button class="btn btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                </td>
            `;
            userTableBody.appendChild(row);
        });
    }

    async function fetchRoles() {
        const response = await fetch(`${apiUrl}/roles`);
        const roles = await response.json();
        const rolesSelect = document.getElementById('roles');
        rolesSelect.innerHTML = '';
        roles.forEach(role => {
            rolesSelect.append(new Option(role.name.substring(5), role.id));
        });
    }

    document.getElementById('addUserButton').onclick = function () {
        document.getElementById('userModalLabel').innerText = 'Add User';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        fetchRoles();
    }

    async function editUser(id) {
        const response = await fetch(`${apiUrl}/edit/${id}`);
        const user = await response.json();
        document.getElementById('userId').value = user.id;
        document.getElementById('name').value = user.name;
        document.getElementById('email').value = user.email;

        document.getElementById('userModalLabel').innerText = 'Edit User';
        $('#userModal').modal('show');
    }

    document.getElementById('userForm').onsubmit = async function(event) {
        event.preventDefault();
        const userId = document.getElementById('userId').value;
        const userData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            roles: Array.from(document.getElementById('roles').selectedOptions).map(option => ({ id: option.value }))
        };

        if (userId) {
            await fetch(`${apiUrl}/edit/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
        } else {
            await fetch(`${apiUrl}/add/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });
        }

        $('#userModal').modal('hide');
        fetchUsers();
    };

    async function deleteUser(id) {
        if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            await fetch(`${apiUrl}/delete/${id}`, { method: 'DELETE' });
            fetchUsers();
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        await fetchAdminData();
        await fetchUsers();
        await fetchRoles();
    });
</script>

</body>
</html>